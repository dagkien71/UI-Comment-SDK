<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test CSV Download</title>
  </head>
  <body>
    <h1>CSV Download Test</h1>

    <button id="test-simple">Test Simple CSV</button>
    <button id="test-complex">
      Test Complex CSV (Similar to CommentsTable)
    </button>

    <div id="log"></div>

    <script>
      function log(message) {
        const logDiv = document.getElementById("log");
        logDiv.innerHTML += "<div>" + message + "</div>";
        console.log(message);
      }

      // Test 1: Simple CSV
      document.getElementById("test-simple").onclick = function () {
        log("ğŸ”„ Testing simple CSV download...");
        const csv = "Name,Age,City\nJohn,25,New York\nJane,30,Paris";
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "test-simple.csv";
        log("ğŸ“ Created download link: " + a.href);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        log("âœ… Simple CSV download triggered");
      };

      // Test 2: Complex CSV (similar to your function)
      document.getElementById("test-complex").onclick = function () {
        log("ğŸ”„ Testing complex CSV download...");

        const comments = [
          {
            id: "1",
            content: "This is a test comment",
            createdBy: { name: "John Doe", role: "admin" },
            status: "bug",
            createdAt: "2024-01-01T10:00:00Z",
            url: "http://example.com",
            replies: [],
            attachments: [{ filename: "test.png" }],
            xpath: "/html/body/div[1]",
          },
          {
            id: "2",
            content: 'Another comment with "quotes" and\nnewlines',
            createdBy: { name: "Jane Smith", role: "user" },
            status: "done",
            createdAt: "2024-01-02T11:00:00Z",
            url: "http://example.com/page2",
            replies: [1, 2],
            attachments: [],
            xpath: "/html/body/div[2]",
          },
        ];

        // Your exact function logic
        const escapeCsvValue = (value) => {
          if (value == null) return "";
          const str = String(value)
            .replace(/"/g, '""')
            .replace(/^([=+\-@])/g, "'$1");
          return `"${str.replace(/\n/g, " ")}"`;
        };

        try {
          const data = comments.map((c) => ({
            ID: c.id ?? "",
            Content: c.content ?? "",
            Author: c.createdBy?.name ?? "",
            Role: c.createdBy?.role ?? "",
            Status: c.status ?? "",
            "Created Date": c.createdAt
              ? new Date(c.createdAt).toISOString()
              : "",
            URL: c.url ?? "",
            "Replies Count": c.replies?.length ?? 0,
            Attachments: c.attachments?.map((a) => a.filename).join("; ") ?? "",
            XPath: c.xpath ?? "",
          }));

          const headers = Object.keys(data[0]);
          const csvRows = [headers.join(",")];

          for (const row of data) {
            const values = headers.map((h) => escapeCsvValue(row[h]));
            csvRows.push(values.join(","));
          }

          const csvString = csvRows.join("\n");
          const blob = new Blob([csvString], {
            type: "text/csv;charset=utf-8;",
          });
          const url = URL.createObjectURL(blob);

          const safeFilename = "test-complex.csv";

          const a = document.createElement("a");
          a.href = url;
          a.download = safeFilename;
          log("ğŸ“ Created download link: " + a.href);
          log("ğŸ“ Download filename: " + a.download);
          log("ğŸ“ Blob type: " + blob.type);
          log("ğŸ“ CSV content preview: " + csvString.substring(0, 100) + "...");

          document.body.appendChild(a);
          log("ğŸ“ Added link to DOM");

          a.click();
          log("ğŸ“ Clicked download link");

          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          log("âœ… Complex CSV download completed");
        } catch (error) {
          log("âŒ Error: " + error.message);
        }
      };
    </script>
  </body>
</html>
